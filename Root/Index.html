<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم تشخیص رنگ سبز پیشرفته</title>
    <style>
        /* تنظیمات پایه */
        :root {
            --primary: #4CAF50;
            --danger: #f44336;
            --background: #1a1a1a;
        }

        body {
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: var(--background);
            color: white;
            font-family: Tahoma;
        }

        /* استایل بخش ویدئو */
        #videoContainer {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 20px 0;
            border: 2px solid #444;
            border-radius: 10px;
            overflow: hidden;
        }

        #videoFeed {
            width: 100%;
            height: auto;
            display: block;
        }

        /* کنترل‌ها */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            max-width: 640px;
            margin: 20px 0;
        }

        button {
            padding: 15px 30px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
        }

        #startBtn {
            background: var(--primary);
            color: white;
        }

        #stopBtn {
            background: var(--danger);
            color: white;
        }

        /* وضعیت سیستم */
        #status {
            width: 100%;
            max-width: 640px;
            padding: 15px;
            border-radius: 8px;
            background: #333;
            margin-top: 10px;
            text-align: center;
        }

        /* نمایشگر رنگ */
        #colorPreview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 20px auto;
            border: 3px solid white;
        }
    </style>
</head>
<body>
    <h1>تشخیص رنگ سبز از دوربین</h1>
    
    <div id="videoContainer">
        <video id="videoFeed" playsinline autoplay></video>
    </div>

    <div class="controls">
        <button id="startBtn">فعال‌سازی دوربین</button>
        <button id="stopBtn" disabled>توقف سیستم</button>
    </div>

    <div id="status">وضعیت: سیستم آماده به کار است</div>
    <div id="colorPreview"></div>

    <script>
        class ColorDetectionSystem {
            constructor() {
                // انتخاب المان‌ها
                this.video = document.getElementById('videoFeed');
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.status = document.getElementById('status');
                this.colorPreview = document.getElementById('colorPreview');

                // تنظیمات اولیه
                this.mediaStream = null;
                this.analysisInterval = null;
                this.isMonitoring = false;

                // تنظیم رویدادها
                this.setupEventListeners();
            }

            setupEventListeners() {
                this.startBtn.addEventListener('click', () => this.initializeCamera());
                this.stopBtn.addEventListener('click', () => this.stopSystem());
            }

            async initializeCamera() {
                try {
                    this.mediaStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    
                    this.video.srcObject = this.mediaStream;
                    this.toggleControls(true);
                    this.updateStatus('دوربین فعال شد - در حال تحلیل...');
                    this.startAnalysis();
                    
                } catch (error) {
                    this.handleError(`خطا در دسترسی به دوربین: ${error.message}`);
                }
            }

            startAnalysis() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                this.analysisInterval = setInterval(() => {
                    canvas.width = this.video.videoWidth;
                    canvas.height = this.video.videoHeight;
                    ctx.drawImage(this.video, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    this.processImage(imageData.data);
                }, 500);
            }

            processImage(pixelData) {
                let greenPixels = 0;
                
                for (let i = 0; i < pixelData.length; i += 4) {
                    const r = pixelData[i];
                    const g = pixelData[i+1];
                    const b = pixelData[i+2];
                    
                    // شرایط تشخیص سبز با حاشیه خطای گسترده
                    if (
                        g > 50 && 
                        g > r * 1.2 && 
                        g > b * 1.2 && 
                        (g - r) > 20 && 
                        (g - b) > 20
                    ) {
                        greenPixels++;
                    }
                }
                
                const greenPercentage = (greenPixels / (pixelData.length / 4)) * 100;
                this.updateColorPreview(greenPercentage);
            }

            updateColorPreview(percentage) {
                this.colorPreview.style.backgroundColor = `rgb(0, ${Math.min(255, percentage * 2.55)}, 0)`;
                this.status.textContent = `درصد سبزی: ${percentage.toFixed(1)}%`;
            }

            toggleControls(isActive) {
                this.startBtn.disabled = isActive;
                this.stopBtn.disabled = !isActive;
                this.isMonitoring = isActive;
            }

            updateStatus(message) {
                this.status.textContent = message;
            }

            handleError(errorMessage) {
                console.error(errorMessage);
                this.status.style.color = '#ff4444';
                this.status.textContent = errorMessage;
                this.toggleControls(false);
            }

            stopSystem() {
                if (this.mediaStream) {
                    this.mediaStream.getTracks().forEach(track => track.stop());
                }
                if (this.analysisInterval) {
                    clearInterval(this.analysisInterval);
                }
                this.toggleControls(false);
                this.updateStatus('سیستم متوقف شد');
                this.colorPreview.style.backgroundColor = 'transparent';
            }
        }

        // راه‌اندازی سیستم پس از بارگذاری کامل صفحه
        window.addEventListener('load', () => {
            new ColorDetectionSystem();
        });
    </script>
</body>
</html>